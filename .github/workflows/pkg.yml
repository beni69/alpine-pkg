
on:
  push:
    branches: [ "main" ]

  workflow_dispatch:

  schedule:
    - cron: "0 0 * * 6" # every weekend

jobs:
  build:
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v3

      - uses: jirutka/setup-alpine@v1
        id: alpine
        with:
          branch: edge
          extra-keys: ./beni-64e2a1a5.rsa.pub
          packages: alpine-sdk

      - name: Setup keys & perms
        run: |
          cp -v ./abuild.conf ./beni-64e2a1a5.rsa.pub /etc/
          echo '{{ secrets.PKG_PRIV_KEY }}' > /etc/beni-64e2a1a5.rsa
          echo 'PACKAGER_PRIVKEY="/etc/beni-64e2a1a5.rsa"' >> /etc/abuild.conf
          adduser runner abuild
        shell: alpine.sh --root {0}

      # Runs a single command using the runners shell
      - name: Build packages
        run: ./ci.sh
        shell: alpine.sh {0}

      # Runs a set of commands using the runners shell
      - name: Show output
        run: tree -a {{ steps.alpine.root-path }}/home/runner/packages/beni
